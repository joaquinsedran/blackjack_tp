<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesa de Blackjack</title>
    <style>
        :root {
            --table-green: #0a4723;
            --felt-green: #0f5c2e;
            --darker-green: #083b1d;
            --border-gold: #b8860b;
            --text-light: #f0f0f0;
            --card-bg: #f8f8f8;
            --card-border: #ccc;
            --red-suit: #d90429;
            --black-suit: #1c1c1c;
            --btn-green: #28a745;
            --btn-red: #dc3545;
            --btn-blue: #007bff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--table-green);
            color: var(--text-light);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            overflow: hidden;
            perspective: 1000px;
        }

        #mesa-juego {
            width: 100%;
            max-width: 900px;
            background-color: var(--felt-green);
            border-radius: 150px / 75px;
            padding: 40px;
            border: 10px solid var(--border-gold);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7), inset 0 0 20px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .area-mano {
            background-color: var(--darker-green);
            border-radius: 10px;
            padding: 20px;
            min-height: 150px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.6);
        }

        .info-jugador {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.5em;
            font-weight: bold;
            text-shadow: 2px 2px 4px #000;
        }

        .cartas-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .carta-container {
            width: 80px;
            height: 120px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }

        .carta-container.flipped {
            transform: rotateY(180deg);
        }

        .carta-container.disappearing {
            transition: opacity 0.5s, transform 0.5s;
            opacity: 0;
            transform: scale(0);
        }

        .carta {
            width: 100%;
            height: 100%;
            position: absolute;
            backface-visibility: hidden;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .carta.front {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 2.2em;
            font-weight: 600;
            padding: 5px;
            transform: rotateY(180deg);
            position: relative;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
        }

        .carta.back {
            background-color: #001f3f;
            background-image:
                linear-gradient(135deg, rgba(255, 255, 255, 0.1) 25%, transparent 25%),
                linear-gradient(225deg, rgba(255, 255, 255, 0.1) 25%, transparent 25%),
                linear-gradient(45deg, rgba(255, 255, 255, 0.1) 25%, transparent 25%),
                linear-gradient(315deg, rgba(255, 255, 255, 0.1) 25%, transparent 25%);
            background-position: 10px 0, 10px 0, 0 0, 0 0;
            background-size: 20px 20px;
            background-repeat: repeat;
            border: 5px solid white;
        }

        .carta.front.red { color: var(--red-suit); }
        .carta.front.black { color: var(--black-suit); }

        .carta .valor-top, .carta .valor-bottom {
            position: absolute;
            font-size: 0.5em;
            line-height: 1;
        }
        .carta .valor-top {
            top: 8px;
            left: 10px;
            text-align: center;
        }
        .carta .valor-bottom {
            bottom: 8px;
            right: 10px;
            transform: rotate(180deg);
            text-align: center;
        }
        .carta .valor-top::after, .carta .valor-bottom::after {
            content: attr(data-palo);
            display: block;
        }

        .carta .palo-centro {
            font-size: 2em;
            opacity: 0.25;
        }

        .controles, .fichas {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn, .ficha {
            padding: 10px 20px;
            font-size: 1em;
            font-weight: bold;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        #btn-nueva-partida { background-color: var(--btn-green); color: white; }
        #btn-limpiar-apuesta { background-color: var(--btn-red); color: white; }
        #btn-doblar { background-color: var(--btn-blue); color: white; }

        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 8px rgba(0,0,0,0.4); }
        .btn:active:not(:disabled) { transform: translateY(1px); box-shadow: 0 2px 3px rgba(0,0,0,0.4); }
        .btn:disabled { background-color: #555; color: #999; cursor: not-allowed; opacity: 0.6; }

        .ficha {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 3px solid #fff;
        }

        #mensaje {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #ffeb3b;
            min-height: 24px;
        }

        #info-saldo {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            font-size: 1.2em;
            font-weight: bold;
            background-color: var(--darker-green);
            border-radius: 0 0 10px 10px;
        }
    </style>
</head>
<body>

<div id="mesa-juego">
    <div id="area-crupier" class="area-mano">
        <div class="info-jugador">Crupier <span id="puntos-crupier"></span></div>
        <div id="cartas-crupier" class="cartas-container"></div>
    </div>

    <div id="area-jugador" class="area-mano">
        <div class="info-jugador">Jugador <span id="puntos-jugador"></span></div>
        <div id="cartas-jugador" class="cartas-container"></div>
    </div>

    <div id="mensaje">Â¡Bienvenido al Blackjack!</div>

    <div class="controles">
        <button id="btn-nueva-partida" class="btn">Nueva Partida</button>
        <button id="btn-pedir" class="btn" disabled>Pedir Carta</button>
        <button id="btn-plantarse" class="btn" disabled>Plantarse</button>
        <button id="btn-doblar" class="btn" disabled>Doblar</button>
        <button id="btn-limpiar-apuesta" class="btn">Limpiar Apuesta</button>
    </div>

    <div class="fichas">
        <button class="ficha" data-valor="10">$10</button>
        <button class="ficha" data-valor="50">$50</button>
        <button class="ficha" data-valor="100">$100</button>
        <button class="ficha" data-valor="500">$500</button>
    </div>

    <div id="info-saldo">
        <span id="apuesta-actual">Apuesta: $0</span>
        <span id="saldo-jugador">Saldo: $1000</span>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const btnNuevaPartida = document.getElementById('btn-nueva-partida');
        const btnPedir = document.getElementById('btn-pedir');
        const btnPlantarse = document.getElementById('btn-plantarse');
        const btnDoblar = document.getElementById('btn-doblar');
        const btnLimpiarApuesta = document.getElementById('btn-limpiar-apuesta');
        const fichasContainer = document.querySelector('.fichas');
        const mensajeEl = document.getElementById('mensaje');
        const saldoEl = document.getElementById('saldo-jugador');
        const apuestaEl = document.getElementById('apuesta-actual');
        const cartasCrupierEl = document.getElementById('cartas-crupier');
        const cartasJugadorEl = document.getElementById('cartas-jugador');
        const puntosCrupierEl = document.getElementById('puntos-crupier');
        const puntosJugadorEl = document.getElementById('puntos-jugador');

        let apuestaActual = 0;
        let saldo = 1000;
        let juegoActivo = false;
        let puedeDoblar = false;
        let accionEnProgreso = false;

        const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

        fichasContainer.addEventListener('click', (e) => {
            if (juegoActivo || !e.target.classList.contains('ficha')) return;
            const valorFicha = parseInt(e.target.dataset.valor);
            if (valorFicha > saldo) {
                mostrarMensaje("No tienes saldo suficiente.");
                setTimeout(() => mostrarMensaje(''), 2000);
                return;
            }
            apuestaActual += valorFicha;
            saldo -= valorFicha;
            actualizarInfoApuestaYSaldo();
        });

        btnLimpiarApuesta.addEventListener('click', () => {
            if (juegoActivo) return;
            saldo += apuestaActual;
            apuestaActual = 0;
            actualizarInfoApuestaYSaldo();
        });

        btnNuevaPartida.addEventListener('click', iniciarPartida);
        btnPedir.addEventListener('click', () => realizarAccion('/api/blackjack/pedir'));
        btnPlantarse.addEventListener('click', () => realizarAccion('/api/blackjack/plantarse'));
        btnDoblar.addEventListener('click', () => realizarAccion('/api/blackjack/doblar'));

        async function iniciarPartida() {
            if (apuestaActual <= 0) {
                mostrarMensaje("Por favor, haz una apuesta.");
                return;
            }
            if (apuestaActual > saldo + apuestaActual) {
                mostrarMensaje("Apuesta invÃ¡lida. Saldo insuficiente.");
                return;
            }

            juegoActivo = true;
            actualizarEstadoBotones();
            limpiarMesa();
            mostrarMensaje('');

            try {
                const response = await fetch('/api/blackjack/iniciar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apuesta: apuestaActual })
                });

                const estado = await response.json();
                juegoActivo = estado.juegoActivo;
                puedeDoblar = estado.puedeDoblar;

                if (!response.ok) {
                     throw new Error(estado.mensaje || 'Apuesta rechazada por el servidor.');
                }

                await animarRepartoInicial(estado);
                renderizarPuntos(estado);
                mostrarMensaje(estado.mensaje);

                if (!juegoActivo) {
                    finalizarRonda(estado);
                }

            } catch (error) {
                console.error("Error al iniciar partida:", error);
                mostrarMensaje(error.message);
                saldo += apuestaActual;
                apuestaActual = 0;
                actualizarInfoApuestaYSaldo();
                juegoActivo = false;
            } finally {
                actualizarEstadoBotones();
            }
        }

        async function realizarAccion(endpoint) {
            if (accionEnProgreso || !juegoActivo) return;

            accionEnProgreso = true;
            desactivarBotonesDeJuego();

            try {
                const response = await fetch(endpoint, { method: 'POST' });
                if (!response.ok) throw new Error('AcciÃ³n no vÃ¡lida.');
                const estado = await response.json();

                mostrarMensaje('');
                juegoActivo = estado.juegoActivo;
                puedeDoblar = estado.puedeDoblar;

                if (endpoint.includes('plantarse') || endpoint.includes('doblar')) {
                    if (endpoint.includes('doblar')) {
                        await animarRepartoCarta(cartasJugadorEl, estado.manosJugador[0].cartas.slice(-1)[0]);
                    }
                    await animarTurnoCrupier(estado);
                    finalizarRonda(estado);
                } else { // 'pedir'
                    await animarRepartoCarta(cartasJugadorEl, estado.manosJugador[0].cartas.slice(-1)[0]);
                    renderizarPuntos(estado);

                    if (!juegoActivo) {
                        await sleep(500);
                        await animarTurnoCrupier(estado);
                        finalizarRonda(estado);
                    }
                }
            } catch (error) {
                console.error(`Error en la acciÃ³n ${endpoint}:`, error);
                mostrarMensaje("Error de comunicaciÃ³n.");
            } finally {
                accionEnProgreso = false;
                if (juegoActivo) {
                    actualizarEstadoBotones();
                }
            }
        }

        function limpiarMesa() {
            cartasCrupierEl.innerHTML = '';
            cartasJugadorEl.innerHTML = '';
            puntosCrupierEl.textContent = '';
            puntosJugadorEl.textContent = '';
        }

        async function animarRepartoInicial(estado) {
            const [c1j, c2j] = estado.manosJugador[0].cartas;
            const [c1c, c2c] = estado.cartasCrupier;

            await animarRepartoCarta(cartasJugadorEl, c1j);
            await animarRepartoCarta(cartasCrupierEl, c1c);
            await animarRepartoCarta(cartasJugadorEl, c2j);
            await animarRepartoCarta(cartasCrupierEl, c2c, true);
        }

        function calcularPuntosMano(cartas) {
            let puntos = 0;
            let ases = 0;
            for (const carta of cartas) {
                if (!carta) continue;
                const valor = carta.valor;
                if (valor === 'A') {
                    ases++;
                    puntos += 11;
                } else if (['K', 'Q', 'J', '10'].includes(valor)) {
                    puntos += 10;
                } else {
                    puntos += parseInt(valor);
                }
            }
            while (puntos > 21 && ases > 0) {
                puntos -= 10;
                ases--;
            }
            return puntos;
        }

        async function animarTurnoCrupier(estadoFinal) {
            const cartasDelCrupier = estadoFinal.cartasCrupier;

            const cartaOcultaEl = cartasCrupierEl.querySelector('.carta-container:not(.flipped)');
            if (cartaOcultaEl) {
                cartaOcultaEl.classList.add('flipped');
                await sleep(600);
                puntosCrupierEl.textContent = `: ${calcularPuntosMano(cartasDelCrupier.slice(0, 2))}`;
            }

            const cartasYaEnMesa = cartasCrupierEl.querySelectorAll('.carta-container').length;
            for (let i = cartasYaEnMesa; i < cartasDelCrupier.length; i++) {
                await sleep(800);
                await animarRepartoCarta(cartasCrupierEl, cartasDelCrupier[i]);
                puntosCrupierEl.textContent = `: ${calcularPuntosMano(cartasDelCrupier.slice(0, i + 1))}`;
            }

            await sleep(500);
            puntosCrupierEl.textContent = `: ${estadoFinal.puntosCrupier}`;
        }

        async function animarRepartoCarta(contenedor, carta, oculta = false) {
            if (!carta) {
                console.error("Se intentÃ³ renderizar una carta invÃ¡lida (null o undefined).");
                return;
            }
            const elementoCarta = crearElementoCarta(carta);
            contenedor.appendChild(elementoCarta);
            await sleep(50);
            if (!oculta) {
                elementoCarta.classList.add('flipped');
            }
            await sleep(500);
        }

        function crearElementoCarta(carta) {
            if (!carta) {
                console.error("Se intentÃ³ renderizar una carta invÃ¡lida (null o undefined).");
                const errorDiv = document.createElement('div');
                errorDiv.textContent = 'Error';
                return errorDiv;
            }
            const container = document.createElement('div');
            container.className = 'carta-container';
            const back = document.createElement('div');
            back.className = 'carta back';
            container.appendChild(back);

            const front = document.createElement('div');
            const paloInfo = obtenerPaloYColor(carta.palo);
            front.className = `carta front ${paloInfo.color}`;
            front.innerHTML = `
                <div class="valor-top" data-palo="${paloInfo.simbolo}">${carta.valor}</div>
                <div class="palo-centro">${paloInfo.simbolo}</div>
                <div class="valor-bottom" data-palo="${paloInfo.simbolo}">${carta.valor}</div>
            `;
            container.appendChild(front);
            return container;
        }

        function renderizarPuntos(estado) {
            puntosCrupierEl.textContent = `: ${estado.puntosCrupier}`;
            puntosJugadorEl.textContent = `: ${estado.manosJugador[0].puntos}`;
        }

        function finalizarRonda(estado) {
            renderizarPuntos(estado);
            mostrarMensaje(estado.mensaje);

            saldo = estado.saldoJugador;
            juegoActivo = false;
            apuestaActual = 0;

            actualizarEstadoBotones();

            setTimeout(() => {
                document.querySelectorAll('.carta-container').forEach(c => c.classList.add('disappearing'));
            }, 2500);
             setTimeout(() => {
                limpiarMesa();
                actualizarInfoApuestaYSaldo();
             }, 3000);
        }

        function desactivarBotonesDeJuego() {
            btnPedir.disabled = true;
            btnPlantarse.disabled = true;
            btnDoblar.disabled = true;
        }

        function actualizarEstadoBotones() {
            btnPedir.disabled = !juegoActivo;
            btnPlantarse.disabled = !juegoActivo;
            btnDoblar.disabled = !juegoActivo || !puedeDoblar;
            btnNuevaPartida.disabled = juegoActivo;
            btnLimpiarApuesta.disabled = juegoActivo;
            fichasContainer.style.pointerEvents = juegoActivo ? 'none' : 'auto';
            fichasContainer.style.opacity = juegoActivo ? 0.5 : 1;
        }

        function actualizarInfoApuestaYSaldo() {
            apuestaEl.textContent = `Apuesta: $${apuestaActual}`;
            saldoEl.textContent = `Saldo: $${saldo}`;
            btnNuevaPartida.disabled = apuestaActual <= 0 || apuestaActual > saldo + apuestaActual;
        }

        function mostrarMensaje(texto) {
            mensajeEl.textContent = texto || '';
        }

        function obtenerPaloYColor(paloStr) {
            switch (paloStr.toLowerCase()) {
                case 'corazones': return { simbolo: '&hearts;', color: 'red' };
                case 'diamantes': return { simbolo: '&diams;', color: 'red' };
                case 'picas': return { simbolo: '&spades;', color: 'black' };
                case 'trÃ©boles': return { simbolo: '&clubs;', color: 'black' };
                default: return { simbolo: '?', color: 'black' };
            }
        }

        actualizarInfoApuestaYSaldo();
    });
</script>

</body>
</html>


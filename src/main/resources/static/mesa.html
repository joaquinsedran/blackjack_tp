<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackjack</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0a3d1e, #1a5e2c);
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .game-container {
            width: 100%;
            max-width: 800px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #ffcc00;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px;
        }

        .game-area {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .player-area, .dealer-area {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
        }

        .area-title {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #ffcc00;
            text-align: center;
        }

        .points {
            font-size: 1.2rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .cards-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            min-height: 120px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .card {
            width: 80px;
            height: 110px;
            background: white;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem;
            color: #333;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .card.new-card {
            opacity: 0;
            transform: translateY(-20px) rotateY(180deg);
            animation: aparecer 0.6s ease forwards;
        }

        @keyframes aparecer {
            to {
                opacity: 1;
                transform: translateY(0) rotateY(0);
            }
        }

        .card.red {
            color: #d40000;
        }

        .card-back {
            background: linear-gradient(45deg, #d40000, #8b0000);
            color: white;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 8px rgba(0, 0, 0, 0.4);
        }

        button:active {
            transform: translateY(1px);
        }

        .new-game {
            background: #4CAF50;
            color: white;
        }

        .hit {
            background: #2196F3;
            color: white;
        }

        .stand {
            background: #FF9800;
            color: white;
        }

        .clear-bet {
            background: #f44336;
            color: white;
        }

        button:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .betting {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .bet-options {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .bet-option {
            padding: 10px 20px;
            background: #444;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            min-width: 80px;
        }

        .bet-option:hover {
            background: #555;
        }

        .bet-option.selected {
            background: #ffcc00;
            color: #000;
            font-weight: bold;
        }

        .bet-option.disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .message {
            text-align: center;
            font-size: 1.3rem;
            margin-top: 20px;
            min-height: 30px;
            color: #ffcc00;
        }

        .error-message {
            color: #ff4444;
        }
    </style>
</head>
<body>
<div class="game-container">
    <div class="header">
        <h1>¡Bienvenido al Blackjack!</h1>
    </div>

    <div class="game-area">
        <div class="dealer-area">
            <div class="area-title">Crupier</div>
            <div class="points">Puntos: <span id="dealer-points">?</span></div>
            <div class="cards-container" id="dealer-cards"></div>
        </div>

        <div class="player-area">
            <div class="area-title">Jugador</div>
            <div class="points">Puntos: <span id="player-points">0</span></div>
            <div class="cards-container" id="player-cards"></div>
        </div>
    </div>

    <div class="message" id="game-message">¡Bienvenido al Blackjack!</div>

    <div class="controls">
        <button class="new-game" id="new-game-btn">Nueva Partida</button>
        <button class="hit" id="hit-btn" disabled>Pedir Carta</button>
        <button class="stand" id="stand-btn" disabled>Plantarse</button>
        <button class="clear-bet" id="clear-bet-btn">Eliminar Apuesta</button>
    </div>

    <div class="betting">
        <div class="bet-options">
            <div class="bet-option" data-value="10">$10</div>
            <div class="bet-option" data-value="50">$50</div>
            <div class="bet-option" data-value="100">$100</div>
            <div class="bet-option" data-value="500">$500</div>
        </div>
    </div>

    <div class="game-info">
        <div>Apuesta: $<span id="current-bet">0</span></div>
        <div>Saldo: $<span id="balance">1000</span></div>
    </div>
</div>

<script>
    class BlackjackFrontend {
        constructor() {
            this.baseUrl = '/api/blackjack';
            this.initializeElements();
            this.attachEventListeners();
            this.currentBet = 0;
            this.balance = 1000;
            this.playerCartasAnteriores = [];
            this.dealerCartasAnteriores = [];
            this.jugadorSePaso = false;

            this.cargarEstado();
        }

        initializeElements() {
            this.playerCardsEl = document.getElementById('player-cards');
            this.dealerCardsEl = document.getElementById('dealer-cards');
            this.playerPointsEl = document.getElementById('player-points');
            this.dealerPointsEl = document.getElementById('dealer-points');
            this.newGameBtn = document.getElementById('new-game-btn');
            this.hitBtn = document.getElementById('hit-btn');
            this.standBtn = document.getElementById('stand-btn');
            this.clearBetBtn = document.getElementById('clear-bet-btn');
            this.currentBetEl = document.getElementById('current-bet');
            this.balanceEl = document.getElementById('balance');
            this.gameMessageEl = document.getElementById('game-message');
            this.betOptions = document.querySelectorAll('.bet-option');
        }

        attachEventListeners() {
            this.newGameBtn.addEventListener('click', () => this.nuevaPartida());
            this.hitBtn.addEventListener('click', () => this.pedirCarta());
            this.standBtn.addEventListener('click', () => this.plantarse());
            this.clearBetBtn.addEventListener('click', () => this.eliminarApuesta());

            this.betOptions.forEach(option => {
                option.addEventListener('click', () => {
                    this.setApuesta(option.getAttribute('data-value'));
                });
            });
        }

        async cargarEstado() {
            try {
                const response = await fetch(`${this.baseUrl}/estado`);
                if (response.ok) {
                    const estado = await response.json();
                    this.actualizarUI(estado);
                }
            } catch (error) {
                console.error('Error cargando estado:', error);
            }
        }

        setApuesta(monto) {
            const montoNum = parseInt(monto);
            if (montoNum > this.balance) {
                this.mostrarError('Saldo insuficiente');
                return;
            }

            this.currentBet += montoNum;
            this.balance -= montoNum;
            this.currentBetEl.textContent = this.currentBet;
            this.balanceEl.textContent = this.balance;
            this.actualizarOpcionesApuesta();
        }

        eliminarApuesta() {
            this.balance += this.currentBet;
            this.currentBet = 0;
            this.currentBetEl.textContent = this.currentBet;
            this.balanceEl.textContent = this.balance;
            this.actualizarOpcionesApuesta();
            this.gameMessageEl.textContent = 'Apuesta eliminada';
            this.gameMessageEl.classList.remove('error-message');
        }

        actualizarOpcionesApuesta() {
            this.betOptions.forEach(option => {
                const valor = parseInt(option.getAttribute('data-value'));
                if (valor > this.balance) {
                    option.classList.add('disabled');
                } else {
                    option.classList.remove('disabled');
                }
                option.classList.remove('selected');
            });
        }

        mostrarError(mensaje) {
            this.gameMessageEl.textContent = mensaje;
            this.gameMessageEl.classList.add('error-message');
            setTimeout(() => {
                this.gameMessageEl.classList.remove('error-message');
            }, 3000);
        }

        async nuevaPartida() {
            if (this.currentBet <= 0) {
                this.mostrarError('Selecciona una apuesta primero');
                return;
            }

            this.playerCartasAnteriores = [];
            this.dealerCartasAnteriores = [];
            this.jugadorSePaso = false;

            try {
                const response = await fetch(`${this.baseUrl}/nueva-partida`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        apuesta: this.currentBet
                    })
                });

                if (response.ok) {
                    const estado = await response.json();
                    this.actualizarUI(estado);
                } else {
                    this.mostrarError('Error al iniciar partida');
                }

            } catch (error) {
                console.error('Error:', error);
                this.mostrarError('Error de conexión');
            }
        }

        async pedirCarta() {
            try {
                const response = await fetch(`${this.baseUrl}/pedir-carta`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const estado = await response.json();
                    this.actualizarUI(estado);
                }

            } catch (error) {
                console.error('Error:', error);
            }
        }

        async plantarse() {
            try {
                const response = await fetch(`${this.baseUrl}/plantarse`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const estado = await response.json();

                    if (estado.mensaje.includes('¡Ganaste!') || estado.mensaje.includes('BLACKJACK')) {
                        this.balance += this.currentBet * 2;
                    } else if (estado.mensaje.includes('Empate')) {
                        this.balance += this.currentBet;
                    }

                    this.currentBet = 0;
                    this.actualizarUI(estado);
                }

            } catch (error) {
                console.error('Error:', error);
            }
        }

        actualizarUI(estado) {
            this.playerPointsEl.textContent = this.obtenerPuntosJugador(estado);

            if (estado.mensaje && estado.mensaje.includes('Te pasaste')) {
                this.jugadorSePaso = true;
                this.dealerPointsEl.textContent = '?';
            } else if (!estado.juegoActivo && !this.jugadorSePaso) {
                const puntosReales = this.calcularPuntosReales(estado.cartasCrupier);
                this.dealerPointsEl.textContent = puntosReales;
            } else {
                this.dealerPointsEl.textContent = estado.puntosCrupier || '?';
            }

            this.renderCartasJugador(estado);
            this.renderCartasCrupier(estado);

            this.balanceEl.textContent = this.balance;
            this.currentBetEl.textContent = estado.apuestaActual || 0;
            this.gameMessageEl.textContent = estado.mensaje || '';

            this.hitBtn.disabled = !estado.juegoActivo;
            this.standBtn.disabled = !estado.juegoActivo;

            this.actualizarOpcionesApuesta();
        }

        obtenerPuntosJugador(estado) {
            if (estado.manosJugador && estado.manosJugador.length > 0) {
                return estado.manosJugador[0].puntos || 0;
            }
            return 0;
        }

        calcularPuntosReales(cartas) {
            if (!cartas || cartas.length === 0) return 0;

            let puntos = 0;
            let ases = 0;

            cartas.forEach(carta => {
                if (carta.valor === 'A') {
                    puntos += 11;
                    ases++;
                } else if (['K', 'Q', 'J', '10'].includes(carta.valor)) {
                    puntos += 10;
                } else {
                    puntos += parseInt(carta.valor);
                }
            });

            while (puntos > 21 && ases > 0) {
                puntos -= 10;
                ases--;
            }

            return puntos;
        }

        renderCartasJugador(estado) {
            this.playerCardsEl.innerHTML = '';

            if (estado.manosJugador && estado.manosJugador.length > 0) {
                const cartasActuales = estado.manosJugador[0].cartas || [];
                const nuevasCartas = this.obtenerNuevasCartas(cartasActuales, this.playerCartasAnteriores);
                this.playerCartasAnteriores = [...cartasActuales];

                this.renderCartasConAnimacion(cartasActuales, nuevasCartas, this.playerCardsEl);
            }
        }

        renderCartasCrupier(estado) {
            this.dealerCardsEl.innerHTML = '';

            const cartasActuales = estado.cartasCrupier || [];
            const mostrarTodas = !estado.juegoActivo && !this.jugadorSePaso;

            const cartasVisibles = [];
            const cartasOcultas = [];

            cartasActuales.forEach((carta, index) => {
                if (mostrarTodas || index === 0) {
                    cartasVisibles.push(carta);
                } else {
                    cartasOcultas.push(carta);
                }
            });

            const nuevasCartas = this.obtenerNuevasCartas(cartasVisibles, this.dealerCartasAnteriores);
            this.dealerCartasAnteriores = [...cartasVisibles];

            this.renderCartasConAnimacion(cartasVisibles, nuevasCartas, this.dealerCardsEl);

            cartasOcultas.forEach(() => {
                this.crearCartaOculta(this.dealerCardsEl);
            });

            if (estado.juegoActivo && cartasActuales.length === 1) {
                this.crearCartaOculta(this.dealerCardsEl);
            }
        }

        obtenerNuevasCartas(cartasActuales, cartasAnteriores) {
            return cartasActuales.filter(cartaActual =>
                !cartasAnteriores.some(cartaAnterior =>
                    this.sonCartasIguales(cartaActual, cartaAnterior)
                )
            );
        }

        sonCartasIguales(carta1, carta2) {
            if (typeof carta1 === 'string' && typeof carta2 === 'string') {
                return carta1 === carta2;
            }
            if (carta1.valor && carta2.valor) {
                return carta1.valor === carta2.valor;
            }
            return false;
        }

        renderCartasConAnimacion(cartas, nuevasCartas, container) {
            cartas.forEach((carta, index) => {
                const esNueva = nuevasCartas.some(nuevaCarta =>
                    this.sonCartasIguales(carta, nuevaCarta)
                );

                setTimeout(() => {
                    this.crearCarta(carta, container, esNueva);
                }, esNueva ? index * 300 : 0);
            });
        }

        crearCarta(carta, container, esNueva = false) {
            const cardEl = document.createElement('div');
            cardEl.className = `card ${esNueva ? 'new-card' : ''}`;

            let valor = '?';
            if (typeof carta === 'string') {
                valor = carta;
            } else if (carta.valor) {
                valor = carta.valor;
            }

            cardEl.textContent = valor;

            if (['J', 'Q', 'K'].includes(valor)) {
                cardEl.classList.add('red');
            }

            container.appendChild(cardEl);
        }

        crearCartaOculta(container) {
            const cardEl = document.createElement('div');
            cardEl.className = 'card card-back';
            cardEl.textContent = '?';
            container.appendChild(cardEl);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        new BlackjackFrontend();
    });
</script>
</body>
</html>